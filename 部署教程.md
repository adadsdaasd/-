# Digital Twin 本地部署教程

## 📋 部署概览

本教程将指导您完成多用户本地部署，实现：
- ✅ 多人版数据共享（所有人看到相同数据）
- ✅ 个人版数据独立（每个人绑定自己的身份）

**部署完成后，您将获得一个本地访问链接，例如：`http://localhost:8501`**

---

## 🎯 部署前准备

### 1. 检查 Python 环境

打开命令行（Windows: `Win+R` → 输入 `cmd` → 回车），运行：

```bash
python --version
```

**要求**：Python 3.9 或更高版本

### 2. 安装依赖

在项目目录下运行：

```bash
pip install -r requirements.txt
```

**验证安装**：
```bash
python -c "import streamlit; print('Streamlit 已安装')"
```

---

## 📦 第一步：管理员设置共享数据（只需一次）

### 场景说明
如果您是第一个部署的人，或者需要初始化共享数据，请执行此步骤。

### 操作步骤

1. **创建共享文件夹**
   
   选择一个所有用户都能访问的位置：
   
   **Windows 网络共享**：
   ```
   \\server\shared\digital_twin
   ```
   
   **本地共享文件夹**：
   ```
   C:\SharedData\DigitalTwin
   ```
   
   **提示**：如果使用本地文件夹，确保所有用户都有读写权限

2. **运行管理员设置工具**
   
   在项目目录下打开命令行，运行：
   ```bash
   python deploy_setup.py --admin
   ```
   
   按提示操作：
   ```
   请输入共享数据目录路径: C:\SharedData\DigitalTwin
   路径不存在，是否创建？(y/n): y
   ```

3. **完成设置**
   
   工具会自动：
   - ✅ 创建共享目录
   - ✅ 生成配置文件 `deployment_config.json`
   - ✅ 初始化共享数据文件 `user_profiles_multi.json`

4. **记录共享路径**
   
   记住这个路径，后续所有用户都需要使用它。

---

## 👤 第二步：用户本地配置（每个用户都需要）

### 方式一：使用部署工具（推荐）

1. **获取共享配置文件路径**
   
   从管理员处获取配置文件路径，例如：
   ```
   C:\SharedData\DigitalTwin\deployment_config.json
   ```
   或网络路径：
   ```
   \\server\shared\digital_twin\deployment_config.json
   ```

2. **运行用户设置工具**
   
   在项目目录下打开命令行，运行：
   ```bash
   python deploy_setup.py --user --config C:\SharedData\DigitalTwin\deployment_config.json
   ```
   
   如果配置文件在网络位置：
   ```bash
   python deploy_setup.py --user --config \\server\shared\digital_twin\deployment_config.json
   ```

3. **验证设置**
   
   工具会显示：
   ```
   ✅ 已读取共享配置：C:\SharedData\DigitalTwin
   ✅ 本地配置目录：C:\Users\YourName\DigitalTwin
   ✅ 用户配置文件已创建
   ```

### 方式二：使用启动脚本（简单快速）

1. **编辑启动脚本**
   
   打开 `start_app.bat`（Windows）或 `start_app.sh`（Linux/Mac）
   
   找到这一行：
   ```batch
   set DIGITAL_TWIN_SHARED_DIR=\\server\shared\digital_twin
   ```
   
   修改为您的共享路径：
   ```batch
   set DIGITAL_TWIN_SHARED_DIR=C:\SharedData\DigitalTwin
   ```

2. **保存文件**

3. **双击运行** `start_app.bat`（Windows）或执行 `./start_app.sh`（Linux/Mac）

### 方式三：手动设置环境变量（临时测试）

**Windows**：
```cmd
set DIGITAL_TWIN_SHARED_DIR=C:\SharedData\DigitalTwin
streamlit run app.py
```

**Linux/Mac**：
```bash
export DIGITAL_TWIN_SHARED_DIR="/mnt/shared/digital_twin"
streamlit run app.py
```

---

## 🚀 第三步：启动应用

### 启动命令

在项目目录下运行：

```bash
streamlit run app.py
```

### 启动成功后的输出

您会看到类似以下输出：

```
You can now view your Streamlit app in your browser.

  Local URL: http://localhost:8501
  Network URL: http://192.168.1.100:8501
```

### 📍 访问链接说明

**Local URL（本地访问）**：
- 地址：`http://localhost:8501`
- 用途：**在本机浏览器中访问**
- 说明：只有本机可以访问

**Network URL（网络访问）**：
- 地址：`http://192.168.1.100:8501`（IP 地址可能不同）
- 用途：**同一局域网内的其他设备可以访问**
- 说明：其他电脑/手机可以通过这个地址访问

### 🌐 如何访问应用

1. **本机访问**：
   - 浏览器会自动打开
   - 或手动打开浏览器，输入：`http://localhost:8501`

2. **其他设备访问**：
   - 确保设备在同一局域网
   - 在浏览器输入 Network URL（如：`http://192.168.1.100:8501`）
   - 如果无法访问，检查防火墙设置

---

## ✅ 第四步：首次使用

### 1. 配置 API Key

在左侧边栏输入您的 DeepSeek API Key：
- 获取地址：https://platform.deepseek.com/
- 输入格式：`sk-...`

### 2. 选择用户模式

**个人版**：
- 点击「绑定我是谁」
- 输入姓名搜索并绑定
- 管理个人数字档案

**多人版**：
- 直接查看团队数据
- 管理组织/小组/人员
- 查看绩效排行榜

### 3. 导入数据

**个人版导入**：
- 上传 CSV/Excel/PDF 简历
- 或粘贴文本让 AI 分析

**多人版导入**：
- 选择目标小组
- 上传多人表格
- 系统自动去重

---

## 🔍 验证部署是否成功

### 检查清单

- [ ] 应用成功启动（看到 Local URL）
- [ ] 浏览器能打开应用
- [ ] 左侧边栏显示正常
- [ ] 多人版能看到共享数据（如果有）
- [ ] 个人版能绑定身份

### 测试数据路径

运行测试脚本验证配置：

```bash
python config_paths.py
```

应该显示：
```
共享数据目录：C:\SharedData\DigitalTwin
共享数据文件：C:\SharedData\DigitalTwin\user_profiles_multi.json
本地配置目录：C:\Users\YourName\DigitalTwin
个人配置文件：C:\Users\YourName\DigitalTwin\self_config.json
```

---

## 🛠️ 常见问题解决

### 问题 1：无法启动应用

**错误**：`streamlit: command not found`

**解决**：
```bash
python -m streamlit run app.py
```

### 问题 2：无法访问共享文件夹

**错误**：`路径不存在` 或 `权限不足`

**解决**：
1. 检查共享路径是否正确
2. 确认有读写权限
3. Windows：右键文件夹 → 属性 → 共享 → 设置共享权限

### 问题 3：端口被占用

**错误**：`Port 8501 is already in use`

**解决**：
```bash
# 使用其他端口
streamlit run app.py --server.port 8502
```

访问：`http://localhost:8502`

### 问题 4：多人版数据不同步

**检查**：
1. 所有用户是否使用相同的共享路径
2. 共享文件是否有写入权限
3. 运行 `python config_paths.py` 检查路径配置

---

## 📊 部署架构图

```
┌─────────────────────────────────────────┐
│      共享数据（所有人共用）              │
│  C:\SharedData\DigitalTwin\             │
│  ├── user_profiles_multi.json          │
│  └── deployment_config.json             │
└─────────────────────────────────────────┘
              ▲              ▲
              │              │
    ┌─────────┴──┐    ┌──────┴─────────┐
    │  用户A      │    │  用户B         │
    │             │    │                │
    │ 本地配置：   │    │ 本地配置：     │
    │ C:\Users\A\ │    │ C:\Users\B\    │
    │ DigitalTwin │    │ DigitalTwin    │
    │             │    │                │
    │ self_config │    │ self_config    │
    │ (绑定p1)    │    │ (绑定p2)       │
    └─────────────┘    └────────────────┘
              │              │
              └──────┬───────┘
                     ▼
            ┌─────────────────┐
            │  Streamlit 应用  │
            │  localhost:8501  │
            └─────────────────┘
```

---

## 🎓 完整部署示例

### 场景：3 人团队部署

**管理员（张三）**：

1. 创建共享文件夹：`C:\TeamData\DigitalTwin`
2. 运行：`python deploy_setup.py --admin`
3. 输入路径：`C:\TeamData\DigitalTwin`
4. 完成！配置文件已创建

**用户A（李四）**：

1. 运行：`python deploy_setup.py --user --config C:\TeamData\DigitalTwin\deployment_config.json`
2. 启动：`streamlit run app.py`
3. 访问：`http://localhost:8501`
4. 绑定身份：搜索"李四"并绑定

**用户B（王五）**：

1. 运行：`python deploy_setup.py --user --config C:\TeamData\DigitalTwin\deployment_config.json`
2. 启动：`streamlit run app.py`
3. 访问：`http://localhost:8501`
4. 绑定身份：搜索"王五"并绑定

**结果**：
- ✅ 三人看到相同的团队数据（多人版）
- ✅ 每人独立管理自己的个人信息（个人版）
- ✅ 数据自动同步到共享位置

---

## 📝 快速参考

### 常用命令

```bash
# 管理员设置
python deploy_setup.py --admin

# 用户设置
python deploy_setup.py --user --config <配置文件路径>

# 启动应用
streamlit run app.py

# 测试配置
python config_paths.py

# 检查依赖
python check_dependencies.py
```

### 重要文件位置

- **共享数据**：`C:\SharedData\DigitalTwin\user_profiles_multi.json`
- **个人配置**：`C:\Users\YourName\DigitalTwin\self_config.json`
- **配置文件**：`C:\SharedData\DigitalTwin\deployment_config.json`

### 访问链接

- **本地访问**：`http://localhost:8501`
- **网络访问**：`http://<您的IP>:8501`（启动时显示）

---

## 🎉 部署完成！

现在您可以：
1. ✅ 在浏览器中访问应用
2. ✅ 使用个人版管理自己的数字档案
3. ✅ 使用多人版查看和管理团队数据
4. ✅ 所有数据自动同步到共享位置

**需要帮助？** 查看 `DEPLOYMENT_PLAN.md` 了解详细架构设计。

---

**最后更新**：2025-02-06
